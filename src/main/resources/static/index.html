<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Softwarearchitecture Assistent</title>
  <link rel="stylesheet" href="css/base.css">
</head>
<body>
<div class="container">
  <h1>Softwarearchitecture Assistent</h1>

  <textarea id="prompt" rows="4" aria-label="Quetsion Area"
            placeholder="Deine Frage an den Softwarearchitektur-Assistenten...">Was ist Softwarearchitektur?</textarea>

  <button id="sendBtn" onclick="sendRequest()">Senden</button>
  <button id="stopBtn" onclick="stopStream()" style="display:none; background:#dc3545;">Stop
  </button>

  <div class="status" id="status"></div>

  <div id="response"></div>
</div>

<script>
  let eventSource = null;
  let responseText = '';

  // Methode 1: Plain Text Stream (einfachste Lösung)
  async function sendRequestPlainText() {
    const prompt = document.getElementById('prompt').value;
    const responseDiv = document.getElementById('response');
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusDiv = document.getElementById('status');

    responseText = '';
    responseDiv.textContent = '';
    sendBtn.disabled = true;
    stopBtn.style.display = 'inline-block';
    statusDiv.textContent = 'Streaming...';

    try {
      const response = await fetch('/ai/askthellm', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: prompt })
      });
      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const {done, value} = await reader.read();

        if (done) {
          statusDiv.textContent = 'Fertig!';
          break;
        }

        // Tokens direkt anzeigen - kein "data:" Parsing nötig!
        const chunk = decoder.decode(value, {stream: true});
        responseText += chunk;
        responseDiv.textContent = responseText;
      }
    } catch (error) {
      statusDiv.textContent = 'Fehler: ' + error.message;
    } finally {
      sendBtn.disabled = false;
      stopBtn.style.display = 'none';
    }
  }

  // Methode 2: Server-Sent Events (falls du SSE verwendest)
  function sendRequestSSE() {
    const prompt = document.getElementById('prompt').value;
    const responseDiv = document.getElementById('response');
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusDiv = document.getElementById('status');

    responseText = '';
    responseDiv.textContent = '';
    sendBtn.disabled = true;
    stopBtn.style.display = 'inline-block';
    statusDiv.textContent = 'Streaming...';

    // EventSource für Server-Sent Events
    eventSource = new EventSource(`/ai/generate-reactive?message=${encodeURIComponent(prompt)}`);

    eventSource.onmessage = function (event) {
      // event.data enthält schon nur den Token (ohne "data:" Präfix)
      // EventSource parst das SSE Format automatisch
      responseText += event.data;
      responseDiv.textContent = responseText;
    };

    eventSource.onerror = function (error) {
      console.error('EventSource error:', error);
      statusDiv.textContent = 'Verbindung beendet';
      eventSource.close();
      sendBtn.disabled = false;
      stopBtn.style.display = 'none';
    };

    // Optional: Custom Event für "complete"
    eventSource.addEventListener('complete', function (event) {
      statusDiv.textContent = 'Fertig!';
      eventSource.close();
      sendBtn.disabled = false;
      stopBtn.style.display = 'none';
    });
  }

  // Verwende die Plain Text Methode (empfohlen)
  function sendRequest() {
    sendRequestPlainText();
  }

  function stopStream() {
    if (eventSource) {
      eventSource.close();
      eventSource = null;
    }
    document.getElementById('sendBtn').disabled = false;
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('status').textContent = 'Gestoppt';
  }
</script>
</body>
</html>